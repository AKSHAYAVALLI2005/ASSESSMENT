#!/bin/bash

# file_analyzer.sh
# Demonstrates:
# recursion, getopt, regex,
# here-doc, here-string,
# error handling, special params

ERROR_LOG="errors.log"

log_error() {
    echo "[ERROR] $1" | tee -a "$ERROR_LOG" >&2
}

# Help Menu

show_help() {
cat << EOF
Usage: $0 [options]

Options:
  -d <directory>   Directory to search recursively
  -k <keyword>     Keyword to search
  -f <file>        Search keyword directly in a file
  --help           Display this help menu

Examples:
  $0 -d logs -k error
  $0 -f script.sh -k TODO
  $0 --help
EOF
}

# Validate inputs (REGEX)

validate_keyword() {
    [[ "$1" =~ ^[a-zA-Z0-9_]+$ ]]
}

# Recursive search function

search_recursive() {
    local dir="$1"
    local keyword="$2"

    for item in "$dir"/*; do
        [[ -e "$item" ]] || continue

        if [[ -d "$item" ]]; then
            search_recursive "$item" "$keyword"
        elif [[ -f "$item" ]]; then
            grep -Hn "$keyword" "$item" 2>/dev/null
        fi
    done
}

# Search using HERE STRING

search_file() {
    local file="$1"
    local keyword="$2"

    while read -r line; do
        if [[ "$line" == *"$keyword"* ]]; then
            echo "$line"
        fi
    done <<< "$(cat "$file")"
}

# Special parameters

echo "Script name : $0"
echo "PID         : $$"
echo "Args count  : $#"
echo "All args    : $@"
echo

# getopt parsing

OPTIONS=$(getopt -o d:k:f: --long help -- "$@")

if [[ $? -ne 0 ]]; then
    log_error "Invalid arguments"
    exit 1
fi

eval set -- "$OPTIONS"

DIR=""
KEY=""
FILE=""

while true; do
    case "$1" in
        -d) DIR="$2"; shift 2 ;;
        -k) KEY="$2"; shift 2 ;;
        -f) FILE="$2"; shift 2 ;;
        --help) show_help; exit 0 ;;
        --) shift; break ;;
        *) break ;;
    esac
done


# Validations

if [[ -n "$KEY" ]] && ! validate_keyword "$KEY"; then
    log_error "Invalid keyword format"
    exit 1
fi

if [[ -n "$DIR" && ! -d "$DIR" ]]; then
    log_error "Directory not found: $DIR"
    exit 1
fi

if [[ -n "$FILE" && ! -f "$FILE" ]]; then
    log_error "File not found: $FILE"
    exit 1
fi

# Main Logic

if [[ -n "$DIR" && -n "$KEY" ]]; then
    echo "Searching '$KEY' in directory '$DIR' recursively..."
    search_recursive "$DIR" "$KEY"

elif [[ -n "$FILE" && -n "$KEY" ]]; then
    echo "Searching '$KEY' in file '$FILE'..."
    search_file "$FILE" "$KEY"

else
    log_error "Missing required options. Use --help"
    exit 1
fi
